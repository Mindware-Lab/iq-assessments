<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cognitive Mode Check - Zone Coach</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body, #root {
      min-height: 100%;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background: #E0E0E0;
    }

    /* Custom slider styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #2764B7;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      background: #22AAFF;
    }

    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #2764B7;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input[type="range"]::-moz-range-thumb:hover {
      background: #22AAFF;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 8px;
      border-radius: 4px;
    }

    input[type="range"]::-moz-range-track {
      height: 8px;
      border-radius: 4px;
      background: #E0E0E0;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CognitiveModeCheck = () => {
      const [step, setStep] = useState('sliders');
      const [sliders, setSliders] = useState({
        energy: 5,
        stress: 5,
        focus: 5,
        noise: 5,
        overwhelm: 5,
        churn: 5,
        rigidity: 5
      });
      const [externalDistractions, setExternalDistractions] = useState(false);
      const [showNeutralWarning, setShowNeutralWarning] = useState(false);
      const [breathElapsed, setBreathElapsed] = useState(0);
      const [currentPhase, setCurrentPhase] = useState({ label: 'Inhale', progress: 0, isInhale: true });
      const [countdownValue, setCountdownValue] = useState(3);
      const [postBreathMode, setPostBreathMode] = useState(null);
      const [sessionResults, setSessionResults] = useState(null);
      const animationFrameRef = useRef(null);
      const startTimeRef = useRef(null);
      const audioContextRef = useRef(null);
      const countdownIntervalRef = useRef(null);
      const lastBeepPhaseRef = useRef(-1);

      const sliderDefinitions = [
        { 
          id: 'energy', 
          label: 'Energy',
          leftAnchor: 'Very low / flat',
          rightAnchor: 'High / ready'
        },
        { 
          id: 'stress', 
          label: 'Stress Load',
          leftAnchor: 'Calm / settled',
          rightAnchor: 'Pressured / keyed-up'
        },
        { 
          id: 'focus', 
          label: 'Focus Stability',
          leftAnchor: 'Diffuse / drifting',
          rightAnchor: 'Stable / flexible'
        },
        { 
          id: 'noise', 
          label: 'Cognitive Noise',
          leftAnchor: 'Quiet / clear',
          rightAnchor: 'Chatter / intrusive'
        },
        { 
          id: 'overwhelm', 
          label: 'Overwhelm',
          leftAnchor: 'Fully manageable',
          rightAnchor: 'Too much / overloaded'
        },
        { 
          id: 'churn', 
          label: 'Strategy Churn (over-explore)',
          leftAnchor: 'Committed / steady plan',
          rightAnchor: 'Churning / switching tactics'
        },
        { 
          id: 'rigidity', 
          label: 'Rigidity (over-tether)',
          leftAnchor: 'Flexible / revising',
          rightAnchor: 'Stuck / autopilot'
        }
      ];

      const breathPatterns = {
        upshift: {
          name: "Upshift",
          description: "Inhale-led breathing to gently raise energy and engagement",
          rationale: "Low activation/engagement ‚Üí inhale-led pacing nudges alertness up",
          instructions: "Breathe through your nose if comfortable. Keep it light and comfortable (not deep gulps). If you feel light-headed, slow down or stop and return to normal breathing.",
          phases: [
            // Block A: 40s total (10 √ó 4s)
            ...Array.from({ length: 10 }, () => [
              { label: 'Inhale', duration: 2000 },
              { label: 'Exhale', duration: 2000 }
            ]).flat(),
            // Block B: 70s total (14 √ó 5s)
            ...Array.from({ length: 14 }, () => [
              { label: 'Inhale', duration: 3000 },
              { label: 'Exhale', duration: 2000 }
            ]).flat(),
            // Block C: 70s total (10 √ó 7s)
            ...Array.from({ length: 10 }, () => [
              { label: 'Inhale', duration: 4000 },
              { label: 'Exhale', duration: 3000 }
            ]).flat()
          ]
        },
        amplify: {
          name: "Amplify",
          description: "Resonance breathing to maintain optimal state",
          rationale: "Balanced and engaged ‚Üí stabilise and amplify",
          instructions: "Breathe comfortably through your nose, keeping breaths belly-led and smooth.",
          phases: Array.from({ length: 18 }, () => [
            { label: 'Inhale', duration: 4000 },
            { label: 'Exhale', duration: 6000 }
          ]).flat()
        },
        downshift: {
          name: "Downshift",
          description: "Cyclic sighing to reduce tension",
          rationale: "High load/noise ‚Üí downshift",
          instructions: "Two short inhales through your nose (second tops up the first), then a long sigh out through your mouth.",
          phases: Array.from({ length: 20 }, () => [
            { label: 'Inhale (1)', duration: 1000 },
            { label: 'Inhale (2)', duration: 1000 },
            { label: 'Sigh Out', duration: 7000 }
          ]).flat()
        }
      };

      const playBeep = () => {
        try {
          if (!audioContextRef.current) {
            audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
          }
          const ctx = audioContextRef.current;
          const oscillator = ctx.createOscillator();
          const gainNode = ctx.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(ctx.destination);
          
          oscillator.frequency.value = 440;
          oscillator.type = 'sine';
          gainNode.gain.value = 0.1;
          
          oscillator.start(ctx.currentTime);
          oscillator.stop(ctx.currentTime + 0.1);
        } catch (error) {
          console.warn('Audio beep failed:', error);
        }
      };

      const calculateResults = () => {
        const E = sliders.energy;
        const S = sliders.stress;
        const F = sliders.focus;
        const N = sliders.noise;
        const O = sliders.overwhelm;
        const C = sliders.churn;
        const R = sliders.rigidity;

        const interference = Math.min(10, N + (externalDistractions ? 2 : 0));
        const pressure = (S + O) / 2;
        const load = (pressure + interference) / 2;
        const stability = F - interference;

        let mode = null;
        let confidence = 'Medium';

        if (E <= 3 && load <= 4 && F <= 5) {
          mode = 'Subcritical (flat/demotivated)';
          confidence = 'High';
        }

        if (!mode) {
          const psiGate =
            E >= 4 && E <= 8 &&
            S <= 6 &&
            O <= 5 &&
            interference <= 5 &&
            F >= 6 &&
            C <= 5 &&
            R <= 5;

          if (psiGate) {
            mode = 'Œ®-band (in the zone)';
            confidence = externalDistractions ? 'Medium' : 'High';
          }
        }

        if (!mode) {
          if (C >= 8 && interference <= 6) {
            mode = 'Supercritical: scattered explore (churn/noise)';
            confidence = 'Medium';
          } else if (R >= 8 && F >= 7 && pressure >= 5) {
            mode = 'Supercritical: rigid control (over-tight/exploit)';
            confidence = 'Medium';
          }
        }

        if (!mode && (load >= 6 || pressure >= 6 || O >= 6)) {
          const rigidControl =
            (R >= 6) &&
            (F >= 7) &&
            (pressure >= 6) &&
            (C <= 5) &&
            (interference <= 7);

          const scatteredExplore =
            (C >= 7) ||
            (interference >= 7 && F <= 6) ||
            (externalDistractions && interference >= 6);

          if (rigidControl && !scatteredExplore) {
            mode = 'Supercritical: rigid control (over-tight/exploit)';
            confidence = (R >= 8 || pressure >= 7) ? 'High' : 'Medium';
          } else if (scatteredExplore && !rigidControl) {
            mode = 'Supercritical: scattered explore (churn/noise)';
            confidence = (C >= 8 || interference >= 8) ? 'High' : 'Medium';
          } else {
            mode = 'Supercritical: mixed/turbulent';
            confidence = 'Low';
          }
        }

        if (!mode) {
          mode = 'Mixed / unclear';
          confidence = 'Low';
        }

        let varianceDriver = 'N/A';
        if (mode.includes('scattered explore')) {
          if (C >= 7 && interference <= 6) varianceDriver = 'Strategy churn (over-exploration)';
          else if (interference >= 7 || externalDistractions) varianceDriver = 'Distraction / noise (interference)';
          else varianceDriver = 'Mixed (churn + noise)';
        }

        let patternId = 'amplify';
        if (mode.startsWith('Subcritical')) patternId = 'upshift';
        else if (mode.startsWith('Œ®-band')) patternId = 'amplify';
        else if (mode.startsWith('Supercritical')) patternId = 'downshift';
        else patternId = (E <= 4) ? 'upshift' : 'amplify';

        let transferSteer = 'Keep the session clean. If you get a click, capture it immediately.';
        if (mode.startsWith('Œ®-band')) {
          transferSteer = 'Portability-ready: if you get a click, do 90-second spike-capture (move + near-misses + cue), then do one quick wrapper-swap probe.';
        } else if (mode.includes('rigid control')) {
          transferSteer = 'Too tight: run bounded divergence (max 3 candidate moves), pick 1, commit for 10 blocks, then capture. Avoid perfection loops.';
        } else if (mode.includes('scattered explore')) {
          transferSteer = (varianceDriver.includes('noise'))
            ? 'Noise-driven: remove distractions, simplify the task, 1 short session only. Postpone variants until stable.'
            : 'Churn-driven: reduce switching. Pick 1 plan, commit for 10 blocks, then capture any genuine upgrade.';
        } else if (mode.startsWith('Subcritical')) {
          transferSteer = 'Gentle start: aim for engagement and clean reps. If a click happens, capture it, but don't chase high scores.';
        }

        let bgColor = '#F5F5F5';
        let borderColor = '#6D6D6D';

        if (mode.startsWith('Subcritical')) {
          bgColor = '#E8F4FF'; borderColor = '#22AAFF';
        } else if (mode.startsWith('Œ®-band')) {
          bgColor = '#F5FFE6'; borderColor = '#CCFF66';
        } else if (mode.includes('rigid control')) {
          bgColor = '#FFF3E0'; borderColor = '#FFB020';
        } else if (mode.includes('scattered explore')) {
          bgColor = '#F2E9FF'; borderColor = '#B07CFF';
        } else if (mode.startsWith('Supercritical')) {
          bgColor = '#FFE8E8'; borderColor = '#FF6B6B';
        }

        return {
          mode,
          confidence,
          pressure,
          interference,
          load,
          stability,
          churn: C,
          rigidity: R,
          varianceDriver,
          externalDistractions,
          sliderValues: { E, S, F, N, O, C, R },
          patternId,
          rationale: breathPatterns[patternId].rationale,
          transferSteer,
          bgColor,
          borderColor
        };
      };

      // Infer approximate slider values from selected post-breath mode
      const inferSlidersFromMode = (mode) => {
        if (mode.startsWith('Subcritical')) {
          return { energy: 3, stress: 3, focus: 4, noise: 4, overwhelm: 3, churn: 4, rigidity: 4 };
        } else if (mode.startsWith('Œ®-band')) {
          return { energy: 6, stress: 4, focus: 7, noise: 3, overwhelm: 3, churn: 3, rigidity: 3 };
        } else if (mode.includes('rigid control')) {
          return { energy: 7, stress: 7, focus: 8, noise: 4, overwhelm: 6, churn: 3, rigidity: 8 };
        } else if (mode.includes('scattered explore')) {
          return { energy: 6, stress: 6, focus: 5, noise: 7, overwhelm: 6, churn: 8, rigidity: 4 };
        } else {
          return { energy: 5, stress: 5, focus: 5, noise: 5, overwhelm: 5, churn: 5, rigidity: 5 };
        }
      };

      // Dose recommendation based on mode and indices
      const getDoseRecommendation = (mode, load, energy, confidence) => {
        // RED: No training today (regulation only)
        if (mode.startsWith('Supercritical') && load >= 7.5) {
          return {
            level: 'red',
            label: 'Skip Training Today',
            description: 'You\'re too far out of band. Focus on regulation/recovery.',
            blocks: 0,
            sessions: 0,
            color: '#FF6B6B',
            bgColor: '#FFE8E8',
            recommendation: 'Do breathing practice only. No cognitive training today.'
          };
        }
        
        if (mode.startsWith('Subcritical') && energy <= 2) {
          return {
            level: 'red',
            label: 'Skip Training Today',
            description: 'Energy too low for quality practice.',
            blocks: 0,
            sessions: 0,
            color: '#FF6B6B',
            bgColor: '#FFE8E8',
            recommendation: 'Rest today. Try again after sleep/recovery.'
          };
        }
        
        if (mode.startsWith('Supercritical') && load >= 5.5 && load < 7.5) {
          return {
            level: 'amber',
            label: 'Light Session (1 session)',
            description: 'Moderate load. Keep it short and clean.',
            blocks: 10,
            sessions: 1,
            color: '#FFB020',
            bgColor: '#FFF3E0',
            recommendation: '1 session (10 blocks). Stop if state worsens.'
          };
        }
        
        if (mode.startsWith('Subcritical') && energy >= 3) {
          return {
            level: 'amber',
            label: 'Gentle Session (1 session)',
            description: 'Start light. Don\'t push for high scores.',
            blocks: 10,
            sessions: 1,
            color: '#FFB020',
            bgColor: '#FFF3E0',
            recommendation: '1 session (10 blocks). Focus on staying engaged, not performance.'
          };
        }
        
        if (mode === 'Mixed / unclear' || confidence === 'Low') {
          return {
            level: 'amber',
            label: 'Standard Session (1 session)',
            description: 'State unclear. Start with one session and monitor.',
            blocks: 10,
            sessions: 1,
            color: '#FFB020',
            bgColor: '#FFF3E0',
            recommendation: '1 session (10 blocks). Re-check state midway.'
          };
        }
        
        if (mode.startsWith('Œ®-band') && confidence !== 'High') {
          return {
            level: 'amber',
            label: 'Standard Session (1 session)',
            description: 'Probably in-band but not certain.',
            blocks: 10,
            sessions: 1,
            color: '#FFB020',
            bgColor: '#FFF3E0',
            recommendation: '1 session (10 blocks). Can extend if feeling good.'
          };
        }
        
        if (mode.startsWith('Œ®-band') && confidence === 'High') {
          return {
            level: 'green',
            label: 'Full Session (2 sessions)',
            description: 'You\'re in the zone. Full protocol available.',
            blocks: 20,
            sessions: 2,
            color: '#CCFF66',
            bgColor: '#F5FFE6',
            recommendation: '2 sessions (20 blocks). You\'re optimally positioned for quality training.'
          };
        }
        
        return {
          level: 'amber',
          label: 'Standard Session (1 session)',
          description: 'Default recommendation.',
          blocks: 10,
          sessions: 1,
          color: '#FFB020',
          bgColor: '#FFF3E0',
          recommendation: '1 session (10 blocks).'
        };
      };

      const handleSliderChange = (id, value) => {
        setSliders(prev => ({ ...prev, [id]: parseInt(value) }));
        setShowNeutralWarning(false);
      };

      const allSlidersNeutral = () => {
        return Object.values(sliders).every(val => val === 5);
      };

      const handleSubmitSliders = () => {
        if (allSlidersNeutral()) {
          setShowNeutralWarning(true);
        } else {
          proceedToCountdown();
        }
      };

      const proceedToCountdown = () => {
        const results = calculateResults();
        setSessionResults(results);
        setStep('countdown');
        setCountdownValue(3);
        startCountdown(results);
      };

      const startCountdown = (results) => {
        if (countdownIntervalRef.current) clearInterval(countdownIntervalRef.current);

        countdownIntervalRef.current = setInterval(() => {
          setCountdownValue(prev => {
            const next = prev - 1;
            if (next <= 0) {
              clearInterval(countdownIntervalRef.current);
              startBreathing(results);
              return 0;
            }
            return next;
          });
        }, 1000);
      };

      const skipCountdown = () => {
        if (countdownIntervalRef.current) {
          clearInterval(countdownIntervalRef.current);
        }
        startBreathing(sessionResults);
      };

      const startBreathing = (results) => {
        if (!results) {
          console.error('No results provided to startBreathing');
          return;
        }
        
        setStep('breath');
        setBreathElapsed(0);
        setCurrentPhase({ label: 'Inhale', progress: 0, isInhale: true });
        startTimeRef.current = performance.now();
        lastBeepPhaseRef.current = -1;
        
        try {
          if (!audioContextRef.current) {
            audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
          }
          if (audioContextRef.current.state === 'suspended') {
            audioContextRef.current.resume();
          }
        } catch (error) {
          console.warn('Audio context initialization failed:', error);
        }
        
        animateBreath(results.patternId);
      };

      const animateBreath = (patternId) => {
        const now = performance.now();
        const elapsed = now - startTimeRef.current;
        const totalDuration = 180000;
        
        if (elapsed >= totalDuration) {
          setStep('recheck');
          cancelAnimationFrame(animationFrameRef.current);
          return;
        }
        
        setBreathElapsed(elapsed);
        
        const pattern = breathPatterns[patternId];
        
        if (!pattern || !pattern.phases || pattern.phases.length === 0) {
          console.error('Invalid pattern:', patternId, pattern);
          return;
        }
        
        let cumulativeTime = 0;
        
        for (let i = 0; i < pattern.phases.length; i++) {
          const phase = pattern.phases[i];
          if (elapsed >= cumulativeTime && elapsed < cumulativeTime + phase.duration) {
            const phaseElapsed = elapsed - cumulativeTime;
            const progress = phaseElapsed / phase.duration;
            
            setCurrentPhase({
              label: phase.label,
              progress: progress,
              isInhale: phase.label.includes('Inhale')
            });
            
            if (lastBeepPhaseRef.current !== i) {
              playBeep();
              lastBeepPhaseRef.current = i;
            }
            
            break;
          }
          cumulativeTime += phase.duration;
        }
        
        animationFrameRef.current = requestAnimationFrame(() => animateBreath(patternId));
      };

      const handlePostBreathCheck = (mode) => {
        setPostBreathMode(mode);
        setStep('summary');
      };

      const handleReset = () => {
        setSliders({
          energy: 5,
          stress: 5,
          focus: 5,
          noise: 5,
          overwhelm: 5,
          churn: 5,
          rigidity: 5
        });
        setExternalDistractions(false);
        setShowNeutralWarning(false);
        setStep('sliders');
        setBreathElapsed(0);
        setSessionResults(null);
        setPostBreathMode(null);
        if (animationFrameRef.current) {
          cancelAnimationFrame(animationFrameRef.current);
        }
        if (countdownIntervalRef.current) {
          clearInterval(countdownIntervalRef.current);
        }
      };

      // Clear stale telemetry on app load (fresh start for each session)
      useEffect(() => {
        try {
          localStorage.removeItem('zoneCheckTelemetry');
        } catch (error) {
          console.warn('Could not clear old telemetry:', error);
        }
      }, []);

      // Cleanup on unmount
      useEffect(() => {
        return () => {
          if (animationFrameRef.current) {
            cancelAnimationFrame(animationFrameRef.current);
          }
          if (countdownIntervalRef.current) {
            clearInterval(countdownIntervalRef.current);
          }
        };
      }, []);

      // Countdown screen
      if (step === 'countdown' && sessionResults) {
        const pattern = breathPatterns[sessionResults.patternId];
        
        return (
          <div style={{ minHeight: '100vh', padding: '1rem 2rem', backgroundColor: '#E0E0E0' }}>
            <div style={{ maxWidth: '48rem', margin: '0 auto' }}>
              <div style={{ borderRadius: '0.5rem', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', padding: '2rem', backgroundColor: '#FFFFFF' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1.5rem' }}>
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L12 22M12 2L8 6M12 2L16 6M12 22L8 18M12 22L16 18M6 8L6 16M18 8L18 16" 
                          stroke="#2764B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#333333' }}>Get Ready</h1>
                </div>

                <div style={{ textAlign: 'center', padding: '3rem 0' }}>
                  <div style={{ fontSize: '6rem', fontWeight: 'bold', marginBottom: '1.5rem', color: '#2764B7' }}>
                    {countdownValue}
                  </div>
                  <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem', color: '#333333' }}>
                    {pattern.name} Breathing
                  </h2>
                  <p style={{ fontSize: '1.125rem', marginBottom: '2rem', color: '#6D6D6D' }}>
                    {pattern.description}
                  </p>
                  <p style={{ fontSize: '0.875rem', marginBottom: '2rem', color: '#333333' }}>
                    {pattern.instructions}
                  </p>
                  
                  <button
                    onClick={skipCountdown}
                    style={{ 
                      padding: '0.75rem 1.5rem', 
                      borderRadius: '0.5rem', 
                      fontWeight: '600',
                      border: '2px solid #2764B7',
                      color: '#2764B7',
                      backgroundColor: '#FFFFFF',
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#E8F4FF'}
                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#FFFFFF'}
                  >
                    Start Now
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Breathing exercise screen
      if (step === 'breath' && sessionResults) {
        const pattern = breathPatterns[sessionResults.patternId];
        const remainingMs = 180000 - breathElapsed;
        const remainingMin = Math.floor(remainingMs / 60000);
        const remainingSec = Math.floor((remainingMs % 60000) / 1000);
        
        const baseSize = 120;
        const expandedSize = 200;
        const currentSize = currentPhase.isInhale 
          ? baseSize + (expandedSize - baseSize) * currentPhase.progress
          : expandedSize - (expandedSize - baseSize) * currentPhase.progress;

        return (
          <div style={{ minHeight: '100vh', padding: '1rem 2rem', backgroundColor: '#E0E0E0' }}>
            <div style={{ maxWidth: '48rem', margin: '0 auto' }}>
              <div style={{ borderRadius: '0.5rem', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', padding: '2rem', backgroundColor: '#FFFFFF' }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1.5rem' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 2L12 22M12 2L8 6M12 2L16 6M12 22L8 18M12 22L16 18M6 8L6 16M18 8L18 16" 
                            stroke="#2764B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                    <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#333333' }}>{pattern.name} Breathing</h1>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <div style={{ fontSize: '0.875rem', fontWeight: '600', color: '#6D6D6D' }}>Time Remaining</div>
                    <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#2764B7' }}>
                      {remainingMin}:{remainingSec.toString().padStart(2, '0')}
                    </div>
                  </div>
                </div>

                <p style={{ textAlign: 'center', marginBottom: '0.5rem', color: '#6D6D6D' }}>{pattern.description}</p>
                <p style={{ textAlign: 'center', marginBottom: '2rem', fontSize: '0.875rem', fontWeight: '500', color: '#333333' }}>{pattern.instructions}</p>

                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: '3rem 0' }}>
                  <div 
                    style={{
                      width: `${currentSize}px`,
                      height: `${currentSize}px`,
                      backgroundColor: currentPhase.isInhale ? '#22AAFF' : '#2764B7',
                      borderRadius: '50%',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      boxShadow: '0 8px 32px rgba(39, 100, 183, 0.3)',
                      transition: 'all 0.1s'
                    }}
                  >
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#FFFFFF' }}>
                        {currentPhase.label}
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ width: '100%', maxWidth: '28rem', marginTop: '3rem', borderRadius: '9999px', overflow: 'hidden', backgroundColor: '#E0E0E0', height: '8px' }}>
                    <div 
                      style={{
                        height: '100%',
                        width: `${(breathElapsed / 180000) * 100}%`,
                        backgroundColor: '#2764B7',
                        transition: 'all 0.1s'
                      }}
                    />
                  </div>
                  
                  <p style={{ marginTop: '1rem', fontSize: '0.875rem', color: '#6D6D6D' }}>
                    Follow the breathing cues. A soft beep marks each phase change.
                  </p>
                </div>

                <div style={{ marginTop: '1.5rem', padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#FFF9E6', border: '1px solid #FFD700' }}>
                  <p style={{ fontSize: '0.875rem', fontWeight: '500', color: '#333333' }}>
                    ‚ö†Ô∏è <strong>Safety note:</strong> If you feel dizzy or unwell, stop and return to normal breathing. Avoid breathwork if you have a condition where this is unsafe.
                  </p>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Post-breath recheck screen
      if (step === 'recheck' && sessionResults) {
        return (
          <div style={{ minHeight: '100vh', padding: '1rem 2rem', backgroundColor: '#E0E0E0' }}>
            <div style={{ maxWidth: '48rem', margin: '0 auto' }}>
              <div style={{ borderRadius: '0.5rem', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', padding: '2rem', backgroundColor: '#FFFFFF' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1.5rem' }}>
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L12 22M12 2L8 6M12 2L16 6M12 22L8 18M12 22L16 18M6 8L6 16M18 8L18 16" 
                          stroke="#2764B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  <h1 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#333333' }}>How do you feel now?</h1>
                </div>

                <p style={{ textAlign: 'center', marginBottom: '2rem', color: '#6D6D6D' }}>
                  You've completed 3 minutes of breathing. Where are you at now?
                </p>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                  {[
                    { label: 'Subcritical (flat/demotivated)', color: '#22AAFF', bg: '#E8F4FF' },
                    { label: 'Œ®-band (in the zone)', color: '#CCFF66', bg: '#F5FFE6' },
                    { label: 'Supercritical: rigid control', color: '#FFB020', bg: '#FFF3E0' },
                    { label: 'Supercritical: scattered explore', color: '#B07CFF', bg: '#F2E9FF' },
                    { label: 'Mixed / unclear', color: '#6D6D6D', bg: '#F5F5F5' }
                  ].map(option => (
                    <button
                      key={option.label}
                      onClick={() => handlePostBreathCheck(option.label)}
                      style={{ 
                        padding: '1.5rem', 
                        borderRadius: '0.5rem', 
                        border: `2px solid ${option.color}`,
                        fontWeight: '600',
                        fontSize: '1.125rem',
                        color: '#333333',
                        backgroundColor: '#FFFFFF',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.currentTarget.style.backgroundColor = option.bg;
                      }}
                      onMouseLeave={(e) => {
                        e.currentTarget.style.backgroundColor = '#FFFFFF';
                      }}
                    >
                      {option.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Summary screen
      if (step === 'summary' && sessionResults) {
        const stillSupercritical = postBreathMode && postBreathMode.startsWith('Supercritical');
        const stillMixed = postBreathMode === 'Mixed / unclear';
        const stillSubcritical = postBreathMode && postBreathMode.startsWith('Subcritical');
        const shouldRepeatDownshift = stillSupercritical || stillMixed;
        const shouldRepeatUpshift = stillSubcritical;
        
        // Calculate dose recommendation
        const finalMode = postBreathMode || sessionResults.mode;
        const inferredSliders = postBreathMode ? inferSlidersFromMode(postBreathMode) : sessionResults.sliderValues;
        const finalInterference = Math.min(10, inferredSliders.noise + (externalDistractions ? 2 : 0));
        const finalPressure = (inferredSliders.stress + inferredSliders.overwhelm) / 2;
        const finalLoad = (finalPressure + finalInterference) / 2;
        const finalEnergy = inferredSliders.energy;
        const finalConfidence = postBreathMode ? 'Medium' : sessionResults.confidence;
        const doseRec = getDoseRecommendation(finalMode, finalLoad, finalEnergy, finalConfidence);
        
        // --- Display values (post-breath if available, otherwise pre-breath) ---
        const finalStability = inferredSliders.focus - finalInterference;
        
        const displaySliderValues = postBreathMode
          ? {
              E: inferredSliders.energy,
              S: inferredSliders.stress,
              F: inferredSliders.focus,
              N: inferredSliders.noise,
              O: inferredSliders.overwhelm,
              C: inferredSliders.churn,
              R: inferredSliders.rigidity
            }
          : sessionResults.sliderValues;
        
        const displayPressure = postBreathMode ? finalPressure : sessionResults.pressure;
        const displayInterference = postBreathMode ? finalInterference : sessionResults.interference;
        const displayStability = postBreathMode ? finalStability : sessionResults.stability;
        const displayLoad = postBreathMode ? finalLoad : sessionResults.load;
        
        const displayConfidence = postBreathMode ? 'User recheck' : sessionResults.confidence;
        
        // Optional: variance driver recalculated for post-breath mode when relevant
        const displayVarianceDriver = (() => {
          if (!postBreathMode) return sessionResults.varianceDriver;
          
          if (!finalMode.includes('scattered explore')) return 'N/A';
          
          const C = inferredSliders.churn;
          const I = finalInterference;
          
          if (C >= 7 && I <= 6) return 'Strategy churn (over-exploration)';
          if (I >= 7 || externalDistractions) return 'Distraction / noise (interference)';
          return 'Mixed (churn + noise)';
        })();
        
        // Compute final colors based on post-breath mode
        let finalBgColor = '#F5F5F5';
        let finalBorderColor = '#6D6D6D';
        
        if (finalMode.startsWith('Subcritical')) {
          finalBgColor = '#E8F4FF';
          finalBorderColor = '#22AAFF';
        } else if (finalMode.startsWith('Œ®-band')) {
          finalBgColor = '#F5FFE6';
          finalBorderColor = '#CCFF66';
        } else if (finalMode.includes('rigid control')) {
          finalBgColor = '#FFF3E0';
          finalBorderColor = '#FFB020';
        } else if (finalMode.includes('scattered explore')) {
          finalBgColor = '#F2E9FF';
          finalBorderColor = '#B07CFF';
        } else if (finalMode.startsWith('Supercritical')) {
          finalBgColor = '#FFE8E8';
          finalBorderColor = '#FF6B6B';
        }
        
        let finalTransferSteer = 'Keep the session clean. If you get a click, capture it immediately.';
        if (finalMode.startsWith('Œ®-band')) {
          finalTransferSteer = 'Portability-ready: if you get a click, do 90-second spike-capture (move + near-misses + cue), then do one quick wrapper-swap probe.';
        } else if (finalMode.includes('rigid control')) {
          finalTransferSteer = 'Too tight: run bounded divergence (max 3 candidate moves), pick 1, commit for 10 blocks, then capture. Avoid perfection loops.';
        } else if (finalMode.includes('scattered explore')) {
          const isNoiseDriven = finalInterference >= 7 || externalDistractions;
          finalTransferSteer = isNoiseDriven
            ? 'Noise-driven: remove distractions, simplify the task, 1 short session only. Postpone variants until stable.'
            : 'Churn-driven: reduce switching. Pick 1 plan, commit for 10 blocks, then capture any genuine upgrade.';
        } else if (finalMode.startsWith('Subcritical')) {
          finalTransferSteer = 'Gentle start: aim for engagement and clean reps. If a click happens, capture it, but don't chase high scores.';
        }
        
        const handleProceedToTraining = () => {
          // Build complete telemetry object
          const telemetry = {
            version: 'zonecheck-v1',
            timestamp: new Date().toISOString(),
            preBreathMode: sessionResults.mode,
            preBreathSliders: sessionResults.sliderValues,
            preBreathStability: sessionResults.stability,
            preBreathPressure: sessionResults.pressure,
            preBreathInterference: sessionResults.interference,
            preBreathLoad: sessionResults.load,
            preBreathVarianceDriver: sessionResults.varianceDriver,
            externalDistractions: sessionResults.externalDistractions,
            postBreathMode: postBreathMode || sessionResults.mode,
            breathPattern: sessionResults.patternId,
            breathingCompleted: postBreathMode !== null,
            dose: doseRec,
            midSessionCheckRequired: doseRec.sessions === 2
          };
          
          try {
            // STRATEGY 1: Store in localStorage (preferred, works same-device)
            localStorage.setItem('zoneCheckTelemetry', JSON.stringify(telemetry));
            
            // Also append to history for later analysis (Principle 12 - telemetry)
            const history = JSON.parse(localStorage.getItem('zoneCheckHistory') || '[]');
            history.push(telemetry);
            
            // Keep only last 30 sessions
            if (history.length > 30) history.shift();
            localStorage.setItem('zoneCheckHistory', JSON.stringify(history));
            
            console.log('Telemetry stored in localStorage');
          } catch (error) {
            console.warn('localStorage not available:', error);
          }
          
          // STRATEGY 2: Also pass minimal data via URL (fallback for cross-device or private browsing)
          const params = new URLSearchParams({
            mode: telemetry.postBreathMode,
            dose: telemetry.dose.level,
            sessions: telemetry.dose.sessions.toString(),
            blocks: telemetry.dose.blocks.toString(),
            ts: Date.now() // Cache buster to prevent URL caching
          });
          
          // Navigate to Game Selector with both strategies active
          window.location.href = `https://mindware-lab.github.io/iq-assessments/game-switcher?${params.toString()}`;
        };
        
        return (
          <div style={{ minHeight: '100vh', padding: '1rem 2rem', backgroundColor: '#E0E0E0' }}>
            <div style={{ maxWidth: '56rem', margin: '0 auto' }}>
              <div style={{ borderRadius: '0.5rem', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', padding: '2rem', backgroundColor: '#FFFFFF' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1.5rem' }}>
                  <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L12 22M12 2L8 6M12 2L16 6M12 22L8 18M12 22L16 18M6 8L6 16M18 8L18 16" 
                          stroke="#2764B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  <h1 style={{ fontSize: '1.875rem', fontWeight: 'bold', color: '#333333' }}>Session Complete</h1>
                </div>

                <div style={{ textAlign: 'center', padding: '2rem 0' }}>
                  <svg style={{ width: '5rem', height: '5rem', margin: '0 auto 1rem' }} fill="none" stroke="#22AAFF" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem', color: '#333333' }}>
                    Great work!
                  </h2>
                  <p style={{ fontSize: '1.125rem', marginBottom: '0.5rem', color: '#6D6D6D' }}>
                    You completed 3 minutes of {breathPatterns[sessionResults.patternId].name} breathing.
                  </p>
                  {postBreathMode && (
                    <p style={{ fontSize: '1rem', marginBottom: '2rem', color: '#6D6D6D' }}>
                      Post-breath state: <strong>{postBreathMode}</strong>
                    </p>
                  )}
                </div>

                <div style={{ borderRadius: '0.5rem', border: `2px solid ${finalBorderColor}`, padding: '1.5rem', marginBottom: '1.5rem', backgroundColor: finalBgColor }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem' }}>
                    <div>
                      <h3 style={{ fontWeight: 'bold', marginBottom: '0.25rem', color: '#333333' }}>Starting Mode</h3>
                      <p style={{ fontSize: '1.25rem', fontWeight: '600', marginBottom: '0.5rem', color: '#2764B7' }}>{sessionResults.mode}</p>
                      {postBreathMode && (
                        <>
                          <h3 style={{ fontWeight: 'bold', marginBottom: '0.25rem', marginTop: '0.75rem', color: '#333333' }}>Current Mode</h3>
                          <p style={{ fontSize: '1.25rem', fontWeight: '600', marginBottom: '0.5rem', color: '#2764B7' }}>{finalMode}</p>
                        </>
                      )}
                      <p style={{ fontSize: '0.875rem', marginBottom: '0.5rem', color: '#333333' }}>
                        Confidence: <strong>{displayConfidence}</strong>
                      </p>
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: '1rem' }}>
                    <h4 style={{ fontSize: '0.875rem', fontWeight: 'bold', marginBottom: '0.5rem', color: '#333333' }}>Slider Values (E, S, F, N, O, C, R)</h4>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(64px, 1fr))', gap: '0.5rem', textAlign: 'center' }}>
                      {['E', 'S', 'F', 'N', 'O', 'C', 'R'].map(key => (
                        <div key={key} style={{ padding: '0.75rem', borderRadius: '0.25rem', backgroundColor: 'rgba(255, 255, 255, 0.7)' }}>
                          <div style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6D6D6D' }}>{key}</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#333333' }}>{displaySliderValues[key]}</div>
                        </div>
                      ))}
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: '0.5rem', marginTop: '0.75rem' }}>
                      <div style={{ padding: '0.75rem', borderRadius: '0.25rem', backgroundColor: 'rgba(255, 255, 255, 0.7)' }}>
                        <div style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6D6D6D' }}>Pressure (S+O)/2</div>
                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#333333' }}>{displayPressure.toFixed(2)}</div>
                      </div>
                      <div style={{ padding: '0.75rem', borderRadius: '0.25rem', backgroundColor: 'rgba(255, 255, 255, 0.7)' }}>
                        <div style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6D6D6D' }}>Interference (N+dist)</div>
                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#333333' }}>{displayInterference.toFixed(2)}</div>
                      </div>
                      <div style={{ padding: '0.75rem', borderRadius: '0.25rem', backgroundColor: 'rgba(255, 255, 255, 0.7)' }}>
                        <div style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6D6D6D' }}>Stability (F‚àíI)</div>
                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#333333' }}>
                          {displayStability > 0 ? `+${displayStability.toFixed(2)}` : displayStability.toFixed(2)}
                        </div>
                      </div>
                      <div style={{ padding: '0.75rem', borderRadius: '0.25rem', backgroundColor: 'rgba(255, 255, 255, 0.7)' }}>
                        <div style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6D6D6D' }}>Load (P+I)/2</div>
                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#333333' }}>{displayLoad.toFixed(2)}</div>
                      </div>
                    </div>

                    {displayVarianceDriver !== 'N/A' && (
                      <div style={{ marginTop: '0.75rem', padding: '0.75rem', borderRadius: '0.25rem', backgroundColor: 'rgba(178, 124, 255, 0.1)', border: '1px solid #B07CFF' }}>
                        <div style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6D6D6D' }}>Variance Driver</div>
                        <div style={{ fontSize: '0.875rem', fontWeight: '500', color: '#333333' }}>{displayVarianceDriver}</div>
                      </div>
                    )}
                  </div>

                  <div style={{ paddingTop: '1rem', marginBottom: '1rem', borderTop: '1px solid rgba(0,0,0,0.1)' }}>
                    <p style={{ fontSize: '0.875rem', fontWeight: '600', color: '#333333' }}>
                      Pattern: {breathPatterns[sessionResults.patternId].name}
                    </p>
                    <p style={{ fontSize: '0.875rem', color: '#333333' }}>
                      {sessionResults.rationale}
                    </p>
                  </div>

                  {/* Far-Transfer Steer */}
                  <div style={{ padding: '1rem', borderRadius: '0.5rem', backgroundColor: 'rgba(34, 170, 255, 0.1)', border: '2px solid #22AAFF', marginBottom: '1rem' }}>
                    <div style={{ display: 'flex', alignItems: 'start', gap: '0.5rem' }}>
                      <span style={{ fontSize: '1.5rem' }}>üéØ</span>
                      <div>
                        <h4 style={{ fontSize: '0.875rem', fontWeight: 'bold', marginBottom: '0.25rem', color: '#333333' }}>Far-Transfer Steer</h4>
                        <p style={{ fontSize: '0.875rem', color: '#333333' }}>
                          {finalTransferSteer}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                {shouldRepeatDownshift && (
                  <div style={{ marginBottom: '1.5rem', padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#FFF9E6', border: '1px solid #FFD700' }}>
                    <p style={{ fontSize: '0.875rem', fontWeight: '500', color: '#333333' }}>
                      üí° <strong>Suggestion:</strong> You're still in a high-load state. Consider repeating the downshift breathing once more, or shortening today's training session.
                    </p>
                  </div>
                )}

                {shouldRepeatUpshift && (
                  <div style={{ marginBottom: '1.5rem', padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#FFF9E6', border: '1px solid #FFD700' }}>
                    <p style={{ fontSize: '0.875rem', fontWeight: '500', color: '#333333' }}>
                      üí° <strong>Suggestion:</strong> You're still low-energy. Consider repeating the upshift breathing once more, then starting training gently.
                    </p>
                  </div>
                )}

                {/* Dose Recommendation Card */}
                <div style={{ 
                  marginBottom: '1.5rem', 
                  padding: '1.5rem', 
                  borderRadius: '0.5rem', 
                  backgroundColor: doseRec.bgColor,
                  border: `3px solid ${doseRec.color}`
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem', gap: '1rem', flexWrap: 'wrap' }}>
                    <div style={{ flex: 1, minWidth: '200px' }}>
                      <h3 style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem', color: '#333333' }}>
                        {doseRec.label}
                      </h3>
                      <p style={{ fontSize: '1rem', marginBottom: '0.75rem', color: '#333333' }}>
                        {doseRec.description}
                      </p>
                    </div>
                    <div style={{ 
                      padding: '0.75rem 1.25rem', 
                      borderRadius: '0.5rem', 
                      backgroundColor: 'rgba(255,255,255,0.7)',
                      textAlign: 'center',
                      minWidth: '120px'
                    }}>
                      <div style={{ fontSize: '0.875rem', fontWeight: '600', color: '#6D6D6D' }}>
                        Sessions
                      </div>
                      <div style={{ fontSize: '2.5rem', fontWeight: 'bold', color: doseRec.color }}>
                        {doseRec.sessions}
                      </div>
                      <div style={{ fontSize: '0.75rem', color: '#6D6D6D' }}>
                        ({doseRec.blocks} blocks)
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ 
                    padding: '1rem', 
                    borderRadius: '0.5rem', 
                    backgroundColor: 'rgba(0,0,0,0.05)',
                    borderLeft: `4px solid ${doseRec.color}`
                  }}>
                    <p style={{ fontSize: '0.875rem', fontWeight: '500', color: '#333333' }}>
                      üìã <strong>Recommendation:</strong> {doseRec.recommendation}
                    </p>
                  </div>
                </div>

                {/* Proceed to Training Button */}
                {doseRec.sessions > 0 && (
                  <button
                    onClick={handleProceedToTraining}
                    style={{ 
                      width: '100%', 
                      padding: '1rem 1.5rem', 
                      borderRadius: '0.5rem', 
                      fontWeight: '600',
                      fontSize: '1.25rem',
                      backgroundColor: doseRec.level === 'green' ? '#22AAFF' : '#2764B7',
                      color: '#FFFFFF',
                      border: 'none',
                      cursor: 'pointer',
                      boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                      transition: 'all 0.2s',
                      marginBottom: '1rem'
                    }}
                    onMouseEnter={(e) => {
                      e.currentTarget.style.backgroundColor = doseRec.level === 'green' ? '#1a88cc' : '#1e4f8f';
                      e.currentTarget.style.transform = 'translateY(-2px)';
                      e.currentTarget.style.boxShadow = '0 6px 12px -2px rgba(0, 0, 0, 0.2)';
                    }}
                    onMouseLeave={(e) => {
                      e.currentTarget.style.backgroundColor = doseRec.level === 'green' ? '#22AAFF' : '#2764B7';
                      e.currentTarget.style.transform = 'translateY(0)';
                      e.currentTarget.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                    }}
                  >
                    {doseRec.level === 'green' 
                      ? '‚úì Proceed to Full Training (2 sessions)' 
                      : '‚Üí Proceed to Training (1 session)'}
                  </button>
                )}

                {/* Red Dose: Recovery Guidance */}
                {doseRec.sessions === 0 && (
                  <div style={{ 
                    padding: '1.5rem', 
                    borderRadius: '0.5rem', 
                    backgroundColor: '#FFE8E8', 
                    border: '3px solid #FF6B6B',
                    textAlign: 'center',
                    marginBottom: '1.5rem'
                  }}>
                    <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>üõë</div>
                    <h3 style={{ fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '0.75rem', color: '#333333' }}>
                      Training Not Recommended Today
                    </h3>
                    <p style={{ fontSize: '1rem', marginBottom: '1rem', color: '#333333' }}>
                      Your current state is too far from the training corridor. Focus on recovery instead.
                    </p>
                    <div style={{ 
                      padding: '1rem', 
                      borderRadius: '0.5rem', 
                      backgroundColor: 'rgba(255,255,255,0.7)',
                      textAlign: 'left'
                    }}>
                      <p style={{ fontSize: '0.875rem', fontWeight: '600', marginBottom: '0.5rem', color: '#333333' }}>
                        Recovery Options:
                      </p>
                      <ul style={{ fontSize: '0.875rem', color: '#333333', paddingLeft: '1.5rem' }}>
                        <li>Repeat downshift breathing in 1-2 hours</li>
                        <li>Light physical movement (walk, stretch)</li>
                        <li>Rest and try again tomorrow</li>
                        <li>Address underlying stressors if possible</li>
                      </ul>
                    </div>
                  </div>
                )}

                <button
                  onClick={handleReset}
                  style={{ 
                    width: '100%', 
                    padding: '0.75rem 1.5rem', 
                    borderRadius: '0.5rem', 
                    fontWeight: '600',
                    fontSize: '1.125rem',
                    backgroundColor: '#2764B7',
                    color: '#FFFFFF',
                    border: 'none',
                    cursor: 'pointer',
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                    transition: 'all 0.2s'
                  }}
                  onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#1e4f8f'}
                  onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#2764B7'}
                >
                  Start New Session
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Main slider screen
      return (
        <div style={{ minHeight: '100vh', padding: '1rem 2rem', backgroundColor: '#E0E0E0' }}>
          <div style={{ maxWidth: '56rem', margin: '0 auto' }}>
            <div style={{ borderRadius: '0.5rem', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', padding: '2rem', backgroundColor: '#FFFFFF' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.5rem' }}>
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2L12 22M12 2L8 6M12 2L16 6M12 22L8 18M12 22L16 18M6 8L6 16M18 8L18 16" 
                        stroke="#2764B7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
                <h1 style={{ fontSize: '1.875rem', fontWeight: 'bold', color: '#333333' }}>Zone Check</h1>
              </div>
              <p style={{ marginBottom: '2rem', color: '#6D6D6D' }}>
                <strong>In the last hour</strong>, where are you right now? Move each slider to match your state.
              </p>

              <div style={{ marginBottom: '2rem' }}>
                {sliderDefinitions.map((slider) => (
                  <div key={slider.id} style={{ marginBottom: '2rem' }}>
                    <label style={{ display: 'block', fontWeight: '600', marginBottom: '0.5rem', color: '#333333' }}>
                      {slider.label}
                    </label>
                    <div style={{ position: 'relative' }}>
                      <input
                        type="range"
                        min="0"
                        max="10"
                        value={sliders[slider.id]}
                        onChange={(e) => handleSliderChange(slider.id, e.target.value)}
                        style={{
                          width: '100%',
                          height: '8px',
                          borderRadius: '0.5rem',
                          background: `linear-gradient(to right, #2764B7 0%, #2764B7 ${sliders[slider.id] * 10}%, #E0E0E0 ${sliders[slider.id] * 10}%, #E0E0E0 100%)`
                        }}
                      />
                      <div 
                        style={{ 
                          position: 'absolute',
                          top: '50%',
                          left: '50%',
                          width: '8px',
                          height: '8px',
                          borderRadius: '50%',
                          transform: 'translate(-50%, -50%)',
                          backgroundColor: '#6D6D6D',
                          pointerEvents: 'none'
                        }}
                      />
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '0.5rem' }}>
                      <span style={{ fontSize: '0.875rem', color: '#6D6D6D' }}>{slider.leftAnchor}</span>
                      <span style={{ fontSize: '1.125rem', fontWeight: 'bold', color: '#2764B7' }}>{sliders[slider.id]}</span>
                      <span style={{ fontSize: '0.875rem', color: '#6D6D6D' }}>{slider.rightAnchor}</span>
                    </div>
                    
                    {/* Œ®-band range indicator */}
                    <div style={{ position: 'relative', marginTop: '0.25rem', height: '4px', backgroundColor: '#E0E0E0', borderRadius: '2px' }}>
                      {slider.id === 'energy' && (
                        <div style={{ position: 'absolute', left: '40%', width: '40%', height: '100%', backgroundColor: '#CCFF66', opacity: 0.3 }} />
                      )}
                      {slider.id === 'stress' && (
                        <div style={{ position: 'absolute', left: '0%', width: '60%', height: '100%', backgroundColor: '#CCFF66', opacity: 0.3 }} />
                      )}
                      {slider.id === 'focus' && (
                        <div style={{ position: 'absolute', left: '60%', width: '40%', height: '100%', backgroundColor: '#CCFF66', opacity: 0.3 }} />
                      )}
                      {slider.id === 'noise' && (
                        <div style={{ position: 'absolute', left: '0%', width: '50%', height: '100%', backgroundColor: '#CCFF66', opacity: 0.3 }} />
                      )}
                      {slider.id === 'overwhelm' && (
                        <div style={{ position: 'absolute', left: '0%', width: '50%', height: '100%', backgroundColor: '#CCFF66', opacity: 0.3 }} />
                      )}
                      {slider.id === 'churn' && (
                        <div style={{ position: 'absolute', left: '0%', width: '50%', height: '100%', backgroundColor: '#CCFF66', opacity: 0.3 }} />
                      )}
                      {slider.id === 'rigidity' && (
                        <div style={{ position: 'absolute', left: '0%', width: '50%', height: '100%', backgroundColor: '#CCFF66', opacity: 0.3 }} />
                      )}
                    </div>
                    <p style={{ fontSize: '0.625rem', color: '#6D6D6D', marginTop: '0.25rem' }}>
                      Green zone = Œ®-band (optimal for training)
                    </p>
                  </div>
                ))}
              </div>

              {/* External Distractions Toggle */}
              <div style={{ marginBottom: '1.5rem', padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#F5F5F5' }}>
                <label style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', cursor: 'pointer' }}>
                  <input
                    type="checkbox"
                    checked={externalDistractions}
                    onChange={(e) => setExternalDistractions(e.target.checked)}
                    style={{ width: '18px', height: '18px' }}
                  />
                  <span style={{ color: '#333333', fontWeight: 600 }}>
                    External distractions present (notifications / people / noisy environment)
                  </span>
                </label>
              </div>

              {showNeutralWarning && (
                <div style={{ marginBottom: '1.5rem', padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#FFF9E6', border: '1px solid #FFD700' }}>
                  <p style={{ marginBottom: '1rem', fontWeight: '500', color: '#333333' }}>
                    You've left everything at neutral. Is that correct?
                  </p>
                  <div style={{ display: 'flex', gap: '0.75rem' }}>
                    <button
                      onClick={proceedToCountdown}
                      style={{ 
                        flex: 1,
                        padding: '0.5rem 1rem',
                        borderRadius: '0.5rem',
                        fontWeight: '600',
                        backgroundColor: '#2764B7',
                        color: '#FFFFFF',
                        border: 'none',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#1e4f8f'}
                      onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#2764B7'}
                    >
                      Yes, continue
                    </button>
                    <button
                      onClick={() => setShowNeutralWarning(false)}
                      style={{ 
                        flex: 1,
                        padding: '0.5rem 1rem',
                        borderRadius: '0.5rem',
                        fontWeight: '600',
                        border: '2px solid #E0E0E0',
                        color: '#333333',
                        backgroundColor: '#FFFFFF',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                      onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#E0E0E0'}
                      onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#FFFFFF'}
                    >
                      Go back and adjust
                    </button>
                  </div>
                </div>
              )}

              <button
                onClick={handleSubmitSliders}
                style={{ 
                  width: '100%',
                  padding: '0.75rem 1.5rem',
                  borderRadius: '0.5rem',
                  fontWeight: '600',
                  fontSize: '1.125rem',
                  backgroundColor: '#2764B7',
                  color: '#FFFFFF',
                  border: 'none',
                  cursor: 'pointer',
                  boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#1e4f8f'}
                onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#2764B7'}
              >
                Continue
              </button>

              <div style={{ marginTop: '2rem', paddingTop: '1.5rem', borderTop: '1px solid #E0E0E0' }}>
                <p style={{ fontSize: '0.75rem', lineHeight: '1.5', color: '#6D6D6D' }}>
                  <strong>About this tool:</strong> This assessment measures your current state across energetic arousal (energy/tiredness) and tense arousal (tension/calmness), plus engagement and cognitive noise. We use breathing as a fast lever on autonomic balance to help shift your state for optimal training.
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const container = document.getElementById('root');
    
    // Robust mount: React 18+ if available, otherwise legacy render
    if (ReactDOM.createRoot) {
      ReactDOM.createRoot(container).render(<CognitiveModeCheck />);
    } else {
      ReactDOM.render(<CognitiveModeCheck />, container);
    }
  </script>
</body>
</html>
